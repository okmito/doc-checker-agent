<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Doc Checker Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .file-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }

        .file-list-item:hover {
            background-color: #f3f4f6;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">ðŸ“„ Smart Doc Checker Agent</h1>
            <p class="mt-2 text-lg text-gray-600">Find contradictions in your documents instantly. Powered by AI.</p>
        </header>

        <main class="bg-white p-6 rounded-2xl shadow-lg">

            <!-- Step 1: File Upload -->
            <div id="upload-section">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">1. Upload Documents</h2>
                <div class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <input type="file" id="file-uploader" accept=".txt,.md" multiple class="hidden">
                    <button id="upload-button"
                        class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        Select 2 or 3 Files (.txt, .md)
                    </button>
                    <p class="text-sm text-gray-500 mt-2">You can also drag and drop files here.</p>
                </div>
                <div id="file-list" class="mt-4"></div>
                <button id="analyze-button"
                    class="w-full mt-4 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                    disabled>
                    Analyze Documents
                </button>
            </div>

            <!-- Step 2: Analysis Report -->
            <div id="report-section" class="hidden mt-6">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">2. Analysis Report</h2>
                <div id="loading-spinner" class="flex justify-center items-center my-8 hidden">
                    <div class="spinner"></div>
                    <p class="ml-4 text-gray-600">AI is analyzing your documents...</p>
                </div>
                <div id="report-content"></div>
                <button id="reset-button"
                    class="w-full mt-6 bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition">
                    Analyze New Documents
                </button>
            </div>

        </main>

        <!-- Side Panel for Usage and Integrations -->
        <aside class="grid md:grid-cols-2 gap-6 mt-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-semibold mb-3">Flexprice Integration</h3>
                <p class="text-gray-600 mb-4">Usage is tracked and billed per document and per report, as required.</p>
                <div class="space-y-2 text-lg">
                    <div class="flex justify-between items-center">
                        <span>Documents Checked:</span>
                        <span id="docs-checked-count"
                            class="font-bold bg-blue-100 text-blue-800 px-3 py-1 rounded-full">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Reports Generated:</span>
                        <span id="reports-generated-count"
                            class="font-bold bg-green-100 text-green-800 px-3 py-1 rounded-full">0</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-semibold mb-3">Pathway Integration</h3>
                <p class="text-gray-600 mb-4">This simulates an external update detected by Pathway, which would trigger
                    a new analysis.</p>
                <button id="pathway-simulate-button"
                    class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition">
                    Simulate External Doc Update
                </button>
            </div>
        </aside>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileUploader = document.getElementById('file-uploader');
            const uploadButton = document.getElementById('upload-button');
            const fileListDiv = document.getElementById('file-list');
            const analyzeButton = document.getElementById('analyze-button');
            const reportSection = document.getElementById('report-section');
            const reportContent = document.getElementById('report-content');
            const loadingSpinner = document.getElementById('loading-spinner');
            const resetButton = document.getElementById('reset-button');
            const pathwaySimulateButton = document.getElementById('pathway-simulate-button');

            const docsCheckedCount = document.getElementById('docs-checked-count');
            const reportsGeneratedCount = document.getElementById('reports-generated-count');

            let uploadedFiles = [];
            let usage = { docsChecked: 0, reportsGenerated: 0 };

            // --- Event Listeners ---
            uploadButton.addEventListener('click', () => fileUploader.click());
            fileUploader.addEventListener('change', handleFileSelect);
            analyzeButton.addEventListener('click', handleAnalysis);
            resetButton.addEventListener('click', resetApp);
            pathwaySimulateButton.addEventListener('click', simulatePathwayUpdate);

            // Drag and Drop functionality
            const dropZone = document.querySelector('.bg-gray-100');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                fileUploader.files = e.dataTransfer.files;
                handleFileSelect({ target: fileUploader });
            });


            function handleFileSelect(event) {
                uploadedFiles = Array.from(event.target.files);
                renderFileList();
                validateFileCount();
            }

            function renderFileList() {
                fileListDiv.innerHTML = '';
                if (uploadedFiles.length > 0) {
                    const list = document.createElement('ul');
                    list.className = 'space-y-2';
                    uploadedFiles.forEach((file, index) => {
                        const listItem = document.createElement('li');
                        listItem.className = 'file-list-item bg-gray-100';
                        listItem.innerHTML = `
                            <span class="font-medium text-gray-700">${file.name}</span>
                            <button data-index="${index}" class="remove-file-btn text-red-500 hover:text-red-700 font-bold">âœ–</button>
                        `;
                        list.appendChild(listItem);
                    });
                    fileListDiv.appendChild(list);

                    document.querySelectorAll('.remove-file-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const indexToRemove = parseInt(e.target.dataset.index);
                            uploadedFiles.splice(indexToRemove, 1);
                            renderFileList();
                            validateFileCount();
                        });
                    });
                }
            }

            function validateFileCount() {
                if (uploadedFiles.length >= 2 && uploadedFiles.length <= 3) {
                    analyzeButton.disabled = false;
                } else {
                    analyzeButton.disabled = true;
                }
            }

            async function handleAnalysis() {
                reportSection.classList.remove('hidden');
                loadingSpinner.classList.remove('hidden');
                reportContent.innerHTML = '';
                analyzeButton.disabled = true;

                // --- Flexprice Billing Simulation ---
                usage.docsChecked += uploadedFiles.length;
                usage.reportsGenerated += 1;
                updateUsageCounter();

                const fileContents = await Promise.all(
                    uploadedFiles.map(file => file.text().then(content => ({ name: file.name, content })))
                );

                // --- Call to Gemini API ---
                try {
                    const report = await analyzeDocumentsWithAI(fileContents);
                    renderReport(report);
                } catch (error) {
                    console.error('Error during AI analysis:', error);
                    reportContent.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                        <strong class="font-bold">Analysis Failed!</strong>
                        <span class="block sm:inline">${error.message || 'An unknown error occurred.'}</span>
                    </div>`;
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }

            function updateUsageCounter() {
                docsCheckedCount.textContent = usage.docsChecked;
                reportsGeneratedCount.textContent = usage.reportsGenerated;
            }

            function renderReport(report) {
                let html = `<div class="bg-gray-100 p-4 rounded-lg">
                    <p class="font-semibold text-lg">Analysis Summary:</p>
                    <p>${report.summary}</p>
                </div>`;

                if (report.contradictions && report.contradictions.length > 0) {
                    html += `<h3 class="text-xl font-semibold mt-6 mb-3 text-red-600">Found ${report.contradictions.length} Contradiction(s)</h3>`;
                    report.contradictions.forEach((item, index) => {
                        html += `
                            <div class="border border-gray-200 rounded-lg mb-4">
                                <details class="p-4">
                                    <summary class="font-semibold cursor-pointer">Conflict #${index + 1}: ${item.document_1} vs. ${item.document_2}</summary>
                                    <div class="mt-4">
                                        <p class="mb-2"><strong class="font-medium">Explanation:</strong> ${item.explanation}</p>
                                        <div class="grid md:grid-cols-2 gap-4 my-4">
                                            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                                <p class="font-semibold text-red-800">From ${item.document_1}:</p>
                                                <code class="block whitespace-pre-wrap text-sm text-red-900">${item.conflicting_text_1}</code>
                                            </div>
                                            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                                <p class="font-semibold text-red-800">From ${item.document_2}:</p>
                                                <code class="block whitespace-pre-wrap text-sm text-red-900">${item.conflicting_text_2}</code>
                                            </div>
                                        </div>
                                        <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                                            <p class="font-semibold text-green-800">ðŸ’¡ Suggested Fix:</p>
                                            <p class="text-green-900">${item.suggestion}</p>
                                        </div>
                                    </div>
                                </details>
                            </div>
                         `;
                    });
                } else {
                    html += `<div class="mt-6 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg" role="alert">
                        <strong class="font-bold">âœ… No contradictions found!</strong>
                        <span class="block sm:inline">The documents appear to be consistent.</span>
                    </div>`;
                }
                reportContent.innerHTML = html;
            }

            function resetApp() {
                uploadedFiles = [];
                fileUploader.value = '';
                reportSection.classList.add('hidden');
                reportContent.innerHTML = '';
                fileListDiv.innerHTML = '';
                validateFileCount();
            }

            function simulatePathwayUpdate() {
                alert("Pathway Simulation: An external document has been updated! In a real application, this would automatically trigger a new analysis against the relevant stored documents to check for new conflicts.");
            }

            // --- AI Logic using Gemini API ---
            async function analyzeDocumentsWithAI(fileContents) {
                const apiKey = ""; // Canvas will provide this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let context = "";
                fileContents.forEach(file => {
                    context += `--- DOCUMENT: ${file.name} ---\n${file.content}\n\n`;
                });

                const systemPrompt = `You are a meticulous Smart Doc Checker Agent. Your primary task is to analyze multiple documents and identify all contradictions, conflicts, and overlaps. Carefully compare rules, policies, dates, numbers, and instructions across all provided documents. You MUST return your findings in the specified JSON format.`;

                const userPrompt = `Analyze the following documents and provide a report. If no contradictions are found, the 'contradictions' list must be empty.
                
                Documents:
                ${context}`;

                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userPrompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "summary": { "type": "STRING", "description": "A brief, one or two-sentence summary of the findings." },
                                "contradictions": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "document_1": { "type": "STRING", "description": "The filename of the first document." },
                                            "document_2": { "type": "STRING", "description": "The filename of the second document." },
                                            "conflicting_text_1": { "type": "STRING", "description": "The specific conflicting text from the first document." },
                                            "conflicting_text_2": { "type": "STRING", "description": "The specific conflicting text from the second document." },
                                            "explanation": { "type": "STRING", "description": "A clear explanation of the conflict." },
                                            "suggestion": { "type": "STRING", "description": "A suggested clarification to resolve the conflict." }
                                        },
                                        "required": ["document_1", "document_2", "conflicting_text_1", "conflicting_text_2", "explanation", "suggestion"]
                                    }
                                }
                            },
                            "required": ["summary", "contradictions"]
                        }
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error ? error.error.message : 'API request failed');
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("Received an empty or invalid response from the AI.");
                }

                return JSON.parse(jsonText);
            }
        });
    </script>
</body>

</html>